#!/bin/bash
#
# A script to clone the Roots.io Trellis repo and update the example.com urls
# to the production ones.
#

if [ -d trellis ]; then
	echo 'Error: Folder "trellis" already exists.'
	exit 1
fi

if [[ $# -eq 0 ]] ; then
	echo 'A domain is required. For example:'
	echo ''
	echo '  gettrellis updated-url.com'
	echo ''
	exit 1
fi

url=$1


# Strips the top level domain. 
folder="$(echo $url | sed -re 's,\.(com|edu|org|net)*$,,g')"

git clone --depth=1 git@github.com:roots/trellis.git 

# Save the commit we are forking from for this initial commit
cd trellis && trellis_forked_commit=$(git rev-parse HEAD) && cd ..

# Re-initialize git
rm -rf trellis/.git
cd trellis && git init

# Compose our first commit
git add .
git commit -m "Add base Trellis files from commit : ${trellis_forked_commit}"

cd trellis
 
echo ''
echo "Updating Trellis development url:"
echo ''
echo "  example.com => ${url}"
echo ''
sed -i -E "s/example/${folder}/g" group_vars/development/wordpress_sites.yml
sed -i -E "s/example/${folder}/g" group_vars/development/vault.yml

git add .
git commit -m "Update example url to ${url}"

